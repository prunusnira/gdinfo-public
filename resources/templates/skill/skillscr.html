<!-- /*****************************************************
 * GITADORA Info Server
 * Developed by Tae Jun Kang a.k.a Prunus Nira
 * (c) Nira 2016
 *
 * 1. This project is protected under GNU AGPL v3.0
 *    Please refer to LICENSE file on root
 * 2. Also, products and libraries used to implement
 *    this server are on USED-LIBRARIES file on root
 *****************************************************/ -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="">
    <meta name="google-signin-client_id"
      content="signin_client_id.apps.googleusercontent.com">
    <link rel="icon" href="/favicon.ico">

    <script src="/function/language.js"></script>
	<script src="/function/language/skill.js"></script>
    <title>GITADORA Info</title>

    <!-- Bootstrap core CSS -->
    <link href="/css/bootstrap.min.css" rel="stylesheet">
	<!-- Custom css -->
	<link href="/css/custom/header.css" rel="stylesheet">
	<link href="/css/custom/footer.css" rel="stylesheet">
	<link href="/css/custom/table.css" rel="stylesheet">
	<link href="/css/custom/skill.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
	
	<!-- Google Adsense -->
	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
	<script>
		(adsbygoogle = window.adsbygoogle || []).push({
			google_ad_client: "ca-pub-adsense_id",
			enable_page_level_ads: true
		});
	</script>
  </head>

  <body>
  	<section class="container" id="loading">
		<h1>LOADING... Please wait</h1>
  	</section>
  	
  	<section class="container">
	  	<div class="pagetop text-center">
	   		<h2>Skill
	    		<script>document.write(txtSkill.scrtitle[lang]);</script>
			</h2>
			<script>document.write(txtSkill.scrdesc[lang]);</script>
	   	</div>
  	</section>
  	
  	<section class="container">
  		<div class="row">
		  	<div class='col-12 btn-group btn-group-justified' id='prevlink'>
				<a v-bind:href='prev' class='btn btn-primary' style='width:100%;'>
					<script>document.write(txtSkill.scrback[lang]);</script>
				</a>
				<a style="width:100%;" class="btn btn-warning" href="#no_div" onclick="scrShotM()">
					<script>document.write(txtSkill.scrshot[lang]);</script>
				</a>
			</div>
		</div>
  	</section>
  	
  	<section class="container" id='scrTable'>
		<div class="card">
			<div class="card-header">
				<div class="row" id="targetInfo">
					<div class="col-12 text-center">
							<h4><b>GITADORA
								<th:block th:switch="${ptype}">
									<span th:case="3">Tri-Boost Re:EVOLVE Top 100</span>
									<span th:case="4">Tri-Boost Top 100</span>
									<span th:case="5">Tri-Boost Re:EVOLVE</span>
									<span th:case="6">Tri-Boost</span>
									<span th:case="7">Matixx Top 100</span>
									<span th:case="8">Matixx</span>
									<span th:case="*">EXCHAIN</span>
								</th:block><br/>
								<span th:if="${gtype}=='gf'">GuitarFreaks</span>
								<span th:if="${gtype}=='dm'">DrumMania</span>
								<span th:if="${ptype}!=1000">Skill by <span id="nameTop"></span></span>
								<span th:unless="${ptype}!=1000">ALL EXCELLENT Skill</span>
							</b></h4>
						<b>Made by GITADORA.info</b>
					</div>
				</div>
			</div>
			<div class="card-body">
				<div class="card-title">
					<div class="col-12">
						<div class="row blackandwhite text-center skillupper" id="statusBar">
							<div class='col-4'>
								{{ statLeftTitle }}<br/><span style="color:white" class='skill' v-html="statLeft"></span>
							</div>
							<div class='col-4'>
								{{ statMidTitle }}<br/>{{ statMid }}
							</div>
							<div class='col-4'>
								{{ statRightTitle }}<br/>{{ statRight }}
							</div>
						</div>
					</div>
				</div>
				<div class="card-text">
					<div class="row" id="targetTable">
						<div class="col-12" id="fullTable">
							<div class='row'>
								<skill-table v-for="skill in skillList" v-bind:skill="skill" v-bind:key="skill.num"></skill-table>
							</div>
						</div>
						<div class="col-12 scrhalf" id='halfTableLeft'>
							<div class='row'>
								<div class='col-12 text-center'>
									<h4><b><span th:if="${gtype} == 'gf'">GF </span><span th:if="${gtype} == 'dm'">DM </span>HOT SKILLS by <span id="nameTop1"></span></b></h4>
									Made by GITADORA.Info
								</div>
							</div>
							<div class='row'>
								<skill-table v-for="skill in hotList" v-bind:skill="skill" v-bind:key="skill.num"></skill-table>
							</div>
						</div>
						<div class="col-12 scrhalf" id='halfTableRight'>
							<div class='row'>
								<div class='col-12 text-center'>
									<h4><b><span th:if="${gtype} == 'gf'">GF </span><span th:if="${gtype} == 'dm'">DM </span>OTHER SKILLS by <span id="nameTop2"></span></b></h4>
									Made by GITADORA.Info
								</div>
							</div>
							<div class='row'>
								<skill-table v-for="skill in otherList" v-bind:skill="skill" v-bind:key="skill.num"></skill-table>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
  	</section>
  	
  	<section class="container">
  		<div id="skillEmpty" style="width:100%; text-align:center;"></div>
		<div class='row text-center'>
			<div class="col-12" id="pager"></div>
		</div>
  	</section>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
	<script src="/js/jquery-3.3.1.min.js"></script>
	<script src="/js/vue.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <script src="/js/html2canvas.js"></script>
    <script src="/js/FileSaver.js"></script>
    <script src="/function/skillfilter.js"></script>
    <script src="/function/skillcolor.js"></script>
    <script src="/function/capture.js"></script>
    <script src="/function/pattern.js"></script>
    <script src="/function/version.js"></script>
    <script src="/function/time.js"></script>
    <script src="/function/towertitle.js"></script>
	<script src="/function/pager.js"></script>
    <script src="/function/overall.js"></script>
    <script src="https://apis.google.com/js/platform.js?onload=gsignLoad" async defer></script>
    <div style='display:none'>
		<form action='/logout' id='logout' method='post'>
		</form>
	</div>

	<template id="skill-template">
		<div class='col-4 col-md-3 skillupper' style='width: 100%;'>
			<div class='row'>
				<div class='col-12' style='padding:0 !important; margin:0px !important;'>
					<div class='text-center'><b>{{ skill.num }}</b></div>
					<div v-bind:style="skill.skillcolor"></div>
				</div>
			</div>
			<div class='row'>
				<div class='col-3' style='padding:0 !important; margin:0px !important;'>
					<img style='width:100%;' v-bind:src="skill.jacketurl" onerror="this.src='/img/music/empty.jpg'" /><br/>
				</div>
				<div class='col-4 text-center' style='padding:0 !important; margin:0px !important;'>
					<img class='skillrank-img' v-bind:src="skill.rankimg" />
					<span v-html="skill.fcimg"></span>
					<img style='width:100%;' v-bind:src="skill.pattern" />
				</div>
				<div class='col-5 text-center' style='font-size:110%; padding:0 !important; margin:0px !important;'>
					{{ skill.level }}<br/>{{ skill.rate }}%<br/>{{ skill.skill }}
				</div>
			</div>
			<div class='row'>
				<div class='col' style='padding:1px !important; margin:0px !important; white-space: nowrap; overflow:hidden; text-overflow:ellipsis;'>
					<b style='word-break: break-all;'>{{ skill.musicname }}</b>
				</div>
			</div>
		</div>
	</template>

	<script th:inline="javascript">
	// Filter
	$("#verfilter").append(generateVerFilter(false));

	var bus = new Vue();
	var exchot = 0;
	var excoth = 0;

	var ptype = /*[[${ptype}]]*/0;
	var gtype = /*[[${gtype}]]*/'';
	var id = /*[[${id}]]*/0;
	var order = /*[[${order}]]*/'';
	var hot = /*[[${hot}]]*/'';
	var stype = /*[[${stype}]]*/'';
	var lv = /*[[${lv}]]*/0;
	var rank = /*[[${rank}]]*/0;
	var ver = /*[[${ver}]]*/'';
	var rival = /*[[${rival}]]*/0;
	var token = /*[[${token}]]*/'';
	var page = /*[[${page}]]*/0;

	Vue.component('skill-table', {
		template: '#skill-template',
		props: {
			skill: Object
		}
	});

	var vmPrev = new Vue({
		el: '#prevlink',
		data: {
			prev: ''
		},
		created: function() {
			var urlbase = window.location.href.split('/skillscr')[1];
			this.prev = '/skill'+urlbase;
		}
	});

	var vmSkill = new Vue({
		el: '#targetTable',
		data: {
			skillList: [],
			hotList: [],
			otherList: [],
			sum1: 0,
			sum2: 0
		},
		methods: {
			sendSum: function() {
				bus.$emit('sendSum', this.sum1+'|'+this.sum2)
			}
		},
		created: function() {
			var self = this;

			$.ajax(generateURL())
			.done(function(data) {
				var json = JSON.parse(data);

				if(json.skill.length > 0) {
					$("#halfTableLeft").hide();
					$("#halfTableRight").hide();
					for(var i = 0; i < json.skill.length; i++) {
						var cur = json.skill[i];
						var obj = generateTable(cur, i, json.page, ptype);

						self.sum1 += obj.skill1;

						self.skillList.push(obj);
					}
				}
				if(json.hskill.length > 0) {
					$("#fullTable").hide();
					for(var i = 0; i < json.hskill.length; i++) {
						var cur = json.hskill[i];
						var obj = generateTable(cur, i, json.page, "2L");

						self.sum1 += obj.skill1;
						exchot = self.sum1;

						self.hotList.push(obj);
					}
				}
				if(json.oskill.length > 0) {
					$("#fullTable").hide();
					for(var i = 0; i < json.oskill.length; i++) {
						var cur = json.oskill[i];
						var obj = generateTable(cur, i, json.page, "2R");

						self.sum2 += obj.skill2;
						excoth = self.sum2;

						self.otherList.push(obj);
					}
				}
				
				updatePager(json.pages);
				
				// 칭호 표시
				getTowerTitle(json.user.id, function(result) {
					if(result != "") {
						var timg = document.createElement("img");
						timg.className = 'towertitle35';
						timg.src = "/img/title/"+result+".png";
						$("#nameTop").prepend(timg);
						$("#nameTop1").prepend(timg.cloneNode(true));
						$("#nameTop2").prepend(timg.cloneNode(true));
					}
				});
				
				$("#nameTop").append("<a class='innerhref' href='/profile/"+json.user.id+"'>"+json.user.name+"</a>");
				$("#nameTop1").append("<a class='innerhref' href='/profile/"+json.user.id+"'>"+json.user.name+"</a>");
				$("#nameTop2").append("<a class='innerhref' href='/profile/"+json.user.id+"'>"+json.user.name+"</a>");
				$("#timeTop").append(new Date(json.user.updatetime));
				
				if(json.skill.length == 0 && json.hskill.length == 0 && json.oskill.length == 0) {
					$("#skillEmpty").append("<h3>"+txtSkill.tablehead.empty[lang]+"</h3>");
				}
				
				self.sendSum();
			});
		},
		updated: function() {
			$("#loading").hide();
		}
	});

	var vmInfo = new Vue({
		el: '#statusBar',
		data: {
			statLeftTitle: '',
			statLeft: '',
			statMidTitle: '',
			statMid: '',
			statRightTitle: '',
			statRight: '',
			oldver: txtSkill.oldver[lang],
			sum1: '',
			sum2: ''
		},
		mounted: function() {
			var self = this;

			bus.$on('sendSum', function(value) {
				var sum = value.split('|');
				//this.sum1 = parseFloat(sum[0]).toFixed(2);
				//this.sum2 = parseFloat(sum[1]).toFixed(2);
				Vue.set(vmInfo.$data, 'sum1', parseFloat(sum[0]).toFixed(2));
				Vue.set(vmInfo.$data, 'sum2', parseFloat(sum[1]).toFixed(2));

				switch(ptype) {
					case 2:
					case 5:
					case 6:
					case 8:
						vmInfo.statMid = vmInfo.sum1;
						vmInfo.statRight = vmInfo.sum2;
						vmInfo.statLeft = (parseFloat(vmInfo.sum1)+parseFloat(vmInfo.sum2)).toFixed(2);
						break;
					case 1:
						vmInfo.statMid = vmInfo.sum1;
						break;
					case 1000:
						if(gtype == "gf") {
							self.statLeftTitle = "GF Skill";
						}
						else if(gtype == "dm") {
							self.statLeftTitle = "DM Skill";
						}
						vmInfo.statMidTitle = "Hot Skill";
						vmInfo.statRightTitle = "Other Skill";
						vmInfo.statMid = exchot.toFixed(2);
						vmInfo.statRight = excoth.toFixed(2);
						vmInfo.statLeft = (exchot+excoth).toFixed(2);
						break;
				}
				updateColor();
			});

			if(ptype != 1000) {
				$.ajax('/d/getuserid/'+id)
				.done(function(data) {
					var json = JSON.parse(data).mydata;

					if(gtype == "gf") {
						self.statLeftTitle = "GF Skill";
						self.statLeft = json.gskill;
					}
					else if(gtype == "dm") {
						self.statLeftTitle = "DM Skill";
						self.statLeft = json.dskill;
					}

					switch(ptype) {
						case 0:
						case 3:
						case 4:
						case 7:
							self.statMidTitle = "Order";

							switch(order) {
							case "skillasc":
								self.statMid = txtSkill.order.skillasc[lang];
								break;
							case "skilldesc":
								self.statMid = txtSkill.order.skilldesc[lang];
								break;
							case "titleasc":
								self.statMid = txtSkill.order.titleasc[lang];
								break;
							case "titledesc":
								self.statMid = txtSkill.order.titledesc[lang];
								break;
							case "verasc":
								self.statMid = txtSkill.order.verasc[lang];
								break;
							case "verdesc":
								self.statMid = txtSkill.order.verdesc[lang];
								break;
							case "rateasc":
								self.statMid = txtSkill.order.rateasc[lang];
								break;
							case "ratedesc":
								self.statMid = txtSkill.order.ratedesc[lang];
								break;
							case "playtime":
								self.statMid = txtSkill.order.playdesc[lang];
								break;
							}

							self.statRightTitle = "Recent Update";
							self.statRight = json.updatetime;
							break;
						case 2:
						case 5:
						case 6:
						case 8:
							vmInfo.statMidTitle = "Hot Skill";
							vmInfo.statRightTitle = "Other Skill";
							break;
						case 1:
							if(hot == "h") {
								vmInfo.statMidTitle = "Hot Total";
							}
							else if(hot == "o") {
								vmInfo.statMidTitle = "Other Total";
							}
							self.statRightTitle = "Recent Update";
							self.statRight = json.updatetime;
							break;
						}
				});
			}
		},
		updated: function() {
			updateColor();
		}
	});

	function generateTable(cur, i, page, ptype) {
		var obj = {};
		obj.num = (page-1)*30+i+1;
		obj.jacketurl = "/img/music/"+cur.musicid+".jpg";
		obj.musiclink = "/music/"+cur.musicid+"/"+id;
		obj.musicname = cur.mname;
		obj.level = (cur.level/100).toFixed(2);
		obj.version = GDVer[cur.version-1].sv;
		obj.meter = "graph"+ptype+i;
		obj.rankimg = getRankImg(cur.rank);
		obj.skill1 = 0;
		obj.skill2 = 0;
		obj.pattern = getPatternImg600(cur.patterncode);

		if(cur.checkfc == "Y") {
			if(cur.rank != "EXC") {
				obj.fcimg = "<img style='width:100%' src='/img/rank/fc_600.png' />";
				}
			else {
				obj.fcimg = "<img style='width:100%' src='/img/rank/exc_600.png' />";
			}
		}
		else {
			if(cur.playtime > 0) {
				obj.fcimg = "<img style='width:100%' src='/img/rank/cleared_600.png' />";
			}
			else {
				obj.fcimg = "<img style='width:100%' src='/img/rank/notplayed_600.png' />";
			}
			if(cur.combo == 0) {
				obj.fcimg = "";
			}
		}

		var rate = cur.rate;
		if(ptype == 4 || ptype == 6) rate = cur.ratetb;
		else if(ptype == 3 || ptype == 5) rate = cur.ratetbre;
		else if(ptype == 7 || ptype == 8) rate = cur.ratemx;

		obj.rate = (rate/100).toFixed(2);
		obj.skill = Math.floor(rate*cur.level*20/10000)/100;
		if(ptype != "2R") {
			obj.skill1 += obj.skill;
		}
		else {
			obj.skill2 += obj.skill;
		}
		obj.skill = obj.skill.toFixed(2);
		obj.skillcolor = "width:100%; height:10px; "+skillTableColorFlat(cur.rate*cur.level*20);

		return obj;
	}

	function generateURL() {
		var baseUrl = "";
		var extvar = "";

		if(ptype == 1000) {
			baseUrl = "/d/exc/"+gtype+'/'+stype;

			if(hot != null) {
				extvar = "?hot="+hot;
			}
		}
		else {
			baseUrl = '/d/skill/'+ptype+'/'+id+'/'+gtype+'/'+page+'/'+order;
			if(lv != null) {
				if(extvar == "") extvar += "?lv="+lv;
				else extvar += "&lv="+lv;
			}
			if(rank != null) {
				if(extvar == "") extvar += "?rank="+rank;
				else extvar += "&rank="+rank;
			}
			if(ver != null) {
				if(extvar == "") extvar += "?ver="+ver;
				else extvar += "&ver="+ver;
			}
			if(hot != null) {
				if(extvar == "") extvar += "?hot="+hot;
				else extvar += "&hot="+hot;
			}
			if(rival != null) {
				if(extvar == "") extvar += "?rival="+rival;
				else extvar += "&rival="+rival;
			}
		}
		
		return baseUrl+extvar;
	}

	function getRankImg(rank) {
		var img = "";

		switch(rank) {
		case "E":
			img = "/img/rank/rank_e.png";
			break;
		case "D":
			img = "/img/rank/rank_d.png";
			break;
		case "C":
			img = "/img/rank/rank_c.png";
			break;
		case "B":
			img = "/img/rank/rank_b.png";
			break;
		case "A":
			img = "/img/rank/rank_a.png";
			break;
		case "S":
			img = "/img/rank/rank_s.png";
			break;
		case "SS":
		case "EXC":
			img = "/img/rank/rank_ss.png";
			break;
		}

		return img;
	}
	
	function updateGraph(rate, index, ptype) {
		var size = 1;
		if(ptype == "2L" || ptype == "2R") size = 0.4;
		var paper = Raphael('graph'+ptype+index, size * window.innerWidth / 12 * 6, 12);
		var background = paper.rect(0, 0, size * window.innerWidth / 12 * 6, 11).attr({
			fill : "#eeeeee",
			"stroke-width" : 0
		});
		var bar = paper.rect(0, 0, size * window.innerWidth / 12 * 6 * rate/100, 10).attr({
			fill : "#9AE6FF",
			"stroke-width" : 0
		});
	}
	
	// pager
	function updatePager(pages) {
		var cpage = page;
		var extvar = "";
		if(lv != null) {
			if(extvar == "") extvar += "?lv="+lv;
			else extvar += "&lv="+lv;
		}
		if(rank != null) {
			if(extvar == "") extvar += "?rank="+rank;
			else extvar += "&rank="+rank;
		}
		if(ver != null) {
			if(extvar == "") extvar += "?ver="+ver;
			else extvar += "&ver="+ver;
		}
		if(hot != null) {
			if(extvar == "") extvar += "?hot="+hot;
			else extvar += "&hot="+hot;
		}
		if(rival != null) {
			if(extvar == "") extvar += "?rival="+rival;
			else extvar += "&rival="+rival;
		}
		
		var urla = '/skill/'+ptype+'/'+id+'/'+gtype+'/';
		var urlb = '/'+order+extvar;

		$("#pager").append(createPager(cpage, pages, urla, urlb));
	}

	function scrShotM() {
		if(ptype == 2 || ptype == 5 || ptype == 6 || ptype == 8) {
			scrShot('#halfTableLeft', id+'_'+gtype+'_hot_'+page+'_'+getTimeScr()+'.jpg');
			scrShot('#halfTableRight', id+'_'+gtype+'_other_'+page+'_'+getTimeScr()+'.jpg');
		}
		else {
			scrShot('#scrTable', id+'_'+gtype+'_all_'+page+'_'+getTimeScr()+'.jpg');
		}
	}
	
	//signout
	function gsignLoad() {
		gapi.load('auth2', function() {
			gapi.auth2.init();
		});
	}
	
	function signOut() {
		var auth2 = gapi.auth2.getAuthInstance();
		auth2.signOut().then(function() {
			console.log('User signed out.');
		});
		$("#logout").submit();
	}
	</script>
	<div th:insert="header :: header"></div>
	<div th:insert="header :: menu"></div>
	<div th:insert="footer :: footer"></div>
  </body>
</html>
