/*****************************************************
 * GITADORA Info Server
 * Developed by Tae Jun Kang a.k.a Prunus Nira
 * (c) Nira 2016
 *
 * 1. This project is protected under GNU AGPL v3.0
 *    Please refer to LICENSE file on root
 * 2. Also, products and libraries used to implement
 *    this server are on USED-LIBRARIES file on root
 *****************************************************/
/**
 * Skill Crawler by Arin (roxyeris@gmail.com)
 * Dynamically modified by GF_Please (toycube.pf@gmail.com)
 *
 */
loadScript("https://gitadora.info/js/bootstrap.min.js", "js");

var lang = navigator.language || navigator.systemLanguage;
if(lang=='ko' || lang=='ko-kr' || lang=='ko-KR') {
	lang = 'ko';
}
else if(lang=='ja' || lang=='ja-jp' || lang=='ja-JP') {
	lang = 'jp';
}
else {
	lang = 'en';
}

var isGFDMall = false;
var curnum = 0;
var delay = 500;

if (navigator.appName == 'Microsoft Internet Explorer' ||  !!(navigator.userAgent.match(/Trident/) || navigator.userAgent.match(/rv 11/)) || (typeof $.browser !== "undefined" && $.browser.msie == 1))
{
	location.href="https://gitadora.info/noie";
}

var text = {
	crawler: {
		notlogin: {
			"jp":"先に<a href='https://gitadora.info/login' target='_blank'>GITADORA Info</a>でログインしてください(利用規約を確認)",
			"ko":"로그인이 필요합니다. <a href='https://gitadora.info/login' target='_blank'>GITADORA Info</a>에서 먼저 로그인 하신 후, 다시 시도해 주세요",
			"en":"Please sign in first from <a href='https://gitadora.info/login' target='_blank'>GITADORA Info</a>"
		},
		loginconfirm: {
			"jp":"<h3><b><font color='red'>※ご注意※</font></b></h3><br/>"+
				"1. GITADORA Infoは本サービスを利用することで発生するe-AmusementサービスからのBANや制限について責任を持っていません<br/>"+
				"2. Google ChromeなどのWebKit類のブラウザがおすすめです (Internet Explorer使用不可)<br/>"+
				"3. ２つ以上の機能を同時に使っては行けません<br/>"+
				"4. 使用前eAmusementのログイン状態をチェックしてください<br/>"+
				"5. 使用中eAmusementの他のページを探索するのは禁止となります (他のデバイスからの接近もエラーを発生することがあります)"+
				"6. 一部のブラウザーはバックグラウンド状態では更新が一時的に止まりますのでご注意ください(ブラウザーのタブも含めて)",
			"ko":"<h3><b><font color='red'>※주의사항※</font></b></h3><br/>"+
				"1. GITADORA Info에 의한 e-Amusement 서비스의 밴에 대해 책임을 지지 않음(이용약관 참고)<br/>"+
				"2. Google Chrome 사용 권장 (Internet Explorer 사용 불가)<br/>"+
				"3. 2가지 이상의 기능을 동시에 실행하지 말 것<br/>"+
				"4. 사용 전 e-Amusement Gate 로그인 상태 체크<br/>"+
				"5. 사용 중 e-Amusement Gate 내의 다른 페이지 접근 금지 (다른 디바이스를 사용한 접근도 안됨)<br/>"+
				"6. 일부 환경에서는 페이지를 백그라운드로 할 경우 갱신이 되지 않으므로 주의 (브라우저 탭 포함)",
			"en":"<h3><b><font color='red'>※CAUTION※</font></b></h3><br/>"+
				"1. GITADORA Info DOES NOT take any charge of BAN from eAmusement service for using the service (Check terms and conditions)<br/>"+
				"2. We recommend to use Google Chrome (Internet Explorer is not usable)<br/>"+
				"3. Do not use 2 or more functions at the same time<br/>"+
				"4. Check your login status of eAmusement<br/>"+
				"5. Do not use other pages of eAmusement site while updating your data (Even in other devices)<br/>"+
				"6. For several environments, you need to set this page as foreground, not background (Including tap of browser)"
		},
		pause: {
			"jp":"読み込みタイム",
			"ko":"곡 별 갱신 대기 시간",
			"en":"Time interval for each song"
		},
		datat: {
			"jp":"データ更新",
			"ko":"데이터 업데이트",
			"en":"Data update"
		},
		datas: {
			"jp":"1.全曲更新は30分から50分、対象曲は3分くらい掛ります<br/>"+
				"2.前作の更新は機種別全パターンの更新だけ可能となります<br/>"+
				"3.読み込みタイムは基本設定(500ms)以上がおすすめです<br/>"+
				"4.ボタンが間違えた時はページを読み直すとかタブを閉めて再更新してください<br/>",
			"ko":"1. 전곡 업데이트는 30~50분, 스킬대상곡은 3분정도 소요됩니다<br/>"+
				"2. 구작 업데이트는 기종 별 전 패턴 업데이트만 가능합니다.<br/>"+
				"3. 업데이트 시 곡 별 갱신 대기시간은 기본 설정(500ms) 이상으로 설정할 것을 추천합니다<br/>"+
				"4. 버튼을 잘못 선택한 경우에는 페이지를 새로고침하거나 닫은 후 다시 불러오세요<br/>",
			"en":"1. All song update takes 30 to 50 minutes and Skill Only update takes 3 minutes<br/>"+
				"2. For old version update, you can only use 'all patterns' for each game(GF or DM)<br/>"+
				"3. We recommend that time interval should be more than basic setting (at least 500ms)<br/>"+
				"4. If you clicked wrong button, please use reload page or close tab and try again<br/>"
		},
		gall: {
			"jp":"GF全曲",
			"ko":"GF전곡",
			"en":"GF ALL"
		},
		dall: {
			"jp":"DM全曲",
			"ko":"DM전곡",
			"en":"DM ALL"
		},
		gtarget: {
			"jp":"GFスキル対象曲",
			"ko":"GF스킬대상곡",
			"en":"GF Skills"
		},
		dtarget: {
			"jp":"DMスキル対象曲",
			"ko":"DM스킬대상곡",
			"en":"DM Skills"
		}
	}
};

function SkillCrawler() {
	var func = new Object();
	var jsonRoot = new Object();
	var hotlist = new Array();
	var otherlist = new Array();
	
	// 프로필 데이터 업로드
	function crawlProfile(gver) {
		console.log("[GITADORA Info] Initializing Profile Update");
		$("#current").text("Initializing Profile Update");
		
		var profurl = "";
		
		if(gver == "mx")
			profurl = "https://p.eagate.573.jp/game/gfdm/gitadora_matixx/p/eam/playdata/profile.html";
		else if(gver == "tbre")
			profurl = "https://p.eagate.573.jp/game/gfdm/gitadora_tbre/p/eam/playdata/profile.html";
		
		$.ajax({
			url: profurl,
			async:false,
			xhr: function() {
				// Get new xhr object using default factory
				var xhr = jQuery.ajaxSettings.xhr();
				// Copy the browser's native setRequestHeader method
				var setRequestHeader = xhr.setRequestHeader;
				// Replace with a wrapper
				xhr.setRequestHeader = function(name, value) {
					// Ignore the X-Requested-With header
					if (name == 'X-Requested-With') return;
					// Otherwise call the native setRequestHeader method
					// Note: setRequestHeader requires its 'this' to be the xhr object,
					// which is what 'this' is here when executed.
					setRequestHeader.call(this, name, value);
				}
				// pass it on to jQuery
				return xhr;
			},
			success: function(data) {
				console.log("[GITADORA Info] Profile Data Received");
				$("#current").text("Profile Data Received");
				var json = new Object();
				var elem = document.createElement('html');
				elem.innerHTML = data;

				// 칭호 가져오기
				var title_div = elem.getElementsByClassName('profile_shogo_frame')[0].innerHTML;
				title_div = title_div.split("<br>")[1];

				// 닉네임
				var name_div = elem.getElementsByClassName('profile_name_frame')[0].innerHTML;
				name_div = name_div.split("<br>")[1];

				// 데이터 테이블
				var profile = elem.querySelector('#profile_tb');

				var arr = parseTable(profile);

				var title = title_div;
				var name = name_div;
				var skill_g = arr[0][1];
				var skill_d = arr[0][2];
				var all_g = arr[1][1];
				var all_d = arr[1][2];
				var clearlv_g = arr[2][1];
				var clearlv_d = arr[2][2];
				var clearnum_g = arr[3][1];
				var clearnum_d = arr[3][2];
				var fclv_g = arr[4][1];
				var fclv_d = arr[4][2];
				var fcnum_g = arr[5][1];
				var fcnum_d = arr[5][2];
				var exclv_g = arr[6][1];
				var exclv_d = arr[6][2];
				var excnum_g = arr[7][1];
				var excnum_d = arr[7][2];
				//var advskill = arr[8][1];

				json.title = title;
				json.name = name;
				json.gskill = skill_g;
				json.dskill = skill_d;
				json.gskillall = all_g;
				json.dskillall = all_d;
				json.gclearlv = clearlv_g;
				json.dclearlv = clearlv_d;
				json.gclearnum = clearnum_g;
				json.dclearnum = clearnum_d;
				json.gfclv = fclv_g;
				json.dfclv = fclv_d;
				json.gfcnum = fcnum_g;
				json.dfcnum = fcnum_d;
				json.gexclv = exclv_g;
				json.dexclv = exclv_d;
				json.gexcnum = excnum_g;
				json.dexcnum = excnum_d;
				//json.advskill = advskill;
				json.crawlToken = crawlToken;

				jsonRoot.profile = json;

				console.log("[GITADORA Info] Uploading Profile...");
				$("#current").text("Uploading Profile...");
				upload(JSON.stringify(jsonRoot), 'profile', gver);
			}
		});
	}
	
	// 곡 데이터 업로드
	/**
	 * gtype: 기종
	 * ctype: crawl 타입 (0: 전곡, 1: 대상, 2: 즐찾, 3: 선택)
	 */
	function crawlSongs(gtype, ctype, timeinterval, lines, gver) {
		var gtype;
		
		var cat = 37; // 고정값
		var sid = 2; // 고정값
		var page = 1; // 고정값
		var index = Array(); // 업로드 노래 수에 따라 변동

		jsonRoot.music = new Object();
		jsonRoot.music.gf = new Array();
		jsonRoot.music.dm = new Array();
		jsonRoot.crawlToken = crawlToken;

		switch(ctype) {
		case 0:
			var idxnum = new Array();
			for(var i = 0; i < cat; i++) {
				idxnum.push(i);
			}
			console.log("[All songs] Collecting URL data");
			$("#current").text("[All songs] Collecting URL data");
			runGetIndex(gtype, cat, timeinterval, idxnum, 0, index, sid, page, gver);
			// gtype, cat, timeinterval, line, i, index, sid, page
			break;
		case 1:
			console.log("[Skill targets] Collecting URL data");
			$("#current").text("[Skill targets] Collecting URL data");
			hotlist = runGetTarget(gtype, 1, gver);
			otherlist = runGetTarget(gtype, 0, gver);
			
			console.log("[Skill targets] Hot songs data collecting...");
			$("#current").text("[Skill targets] Hot songs data collecting...");
			runGetSongInfoForTarget(hotlist, gtype, timeinterval, 0, 1, gver);
			break;
		}
	}

	function runGetIndex(gtype, cat, timeinterval, idx, i, index, sid, page, gver) {
		if(i < cat) {
			getIndex(gtype, idx[i], gver).success(function(data) {
				var elem = document.createElement('html');
				elem.innerHTML = data;
	
				// get table
				var list_table = $(elem).find('table.music_table_tb').children('tbody').children('tr');
				if(gtype=='gf') index[i] = list_table.length/2;
				else index[i] = list_table.length;
			});
			console.log("[Collecting URL] Category "+ (i+1) +" / "+ cat +" checked");
			$("#current").text("[Collecting URL] Category "+ (i+1) +" / "+ cat +" checked");
			
			setTimeout(function() {
				runGetIndex(gtype, cat, timeinterval, idx, i+1, index, sid, page, gver);
			}, timeinterval);
		}
		else {
			console.log("Skill data collecting...");
			$("#current").text("Skill data collecting...");
			runGetSongInfo(gtype, idx, cat, sid, page, index, timeinterval, 0, 0, gver);
			// 0, 0: 카테고리, 페이지 내 순서 (i, j)
		}
	}
	
	function runGetTarget(gtype, stype, gver) {
		var linklist = new Array();
		getTarget(gtype, stype, gver).success(function(data) {
			// get all link to each song -> run get song info
			var elem = document.createElement('html');
			elem.innerHTML = data;

			// Song title
			var link = $(elem).find('.text_link');
			
			link.each(function(idx, val) {
				linklist.push(val.href);
				console.log("[Collecting URL] "+ idx +" checked");
				$("#current").text("[Collecting URL] "+ idx +" checked");
			});
		});
		return linklist;
	}

	function runGetSongInfo(gtype, lines, cat, sid, page, index, timeinterval, i, j, gver) {
		// i = 현재 카테고리, j = 카테고리 내 곡 순서
		if(i < cat) {
			if(j < index[i]) {
				// 목록 페이지로 돌아옴 (안하면 오류남)
				getIndex(gtype, i, gver);
				// 곡 페이지로 이동
				getSongInfo(lines[i], gtype, j, sid, page, gver)
						.success(function(data) {onSongSuccess(gtype, data);});
						
				setTimeout(function() {
					runGetSongInfo(gtype, lines, cat, sid, page, index, timeinterval, i, j+1, gver);
				}, timeinterval);
			}
			else {
				setTimeout(function() {
					runGetSongInfo(gtype, lines, cat, sid, page, index, timeinterval, i+1, 0, gver);
				}, timeinterval);
			}
		}
		else {
			console.log("Uploading skill data");
			$("#current").text("Uploading skill data");
			upload(JSON.stringify(jsonRoot), 'skill', gver);
			
			console.log("Update complete");
			$("#current").text("Update complete");
			crawlProfile(gver);
		}
	}
	
	function runGetSongInfoForTarget(urllist, gtype, timeinterval, i, stype, gver) {
		if(i < urllist.length) {
			switch(stype) {
			case 0:
			case 1:
				getTarget(gtype, stype, gver);
				break;
			}
			getSongInfoForTarget(urllist[i])
					.success(function(data) {onSongSuccess(gtype, data);});
			setTimeout(function() {
				runGetSongInfoForTarget(urllist, gtype, timeinterval, i+1, stype, gver);
			}, timeinterval);
		}
		else if(stype == 1) {
			// Hot곡 완료 시 Other 수행
			console.log("[Skill targets] Other songs data collecting...");
			$("#current").text("[Skill targets] Other songs data collecting...");
			runGetSongInfoForTarget(otherlist, gtype, timeinterval, 0, 0, gver);
		}
		else {
			// 완전 다 끝나면 마무리
			console.log("Uploading skill data");
			$("#current").text("Uploading skill data");
			upload(JSON.stringify(jsonRoot), 'skill', gver);
			
			console.log("Update complete");
			$("#current").text("Update complete");
			crawlProfile(gver);
		}
	}
	
	function onSongSuccess(gtype, data) {
		var jsonMusic = new Object();
		//jsonMusic.cat = lines[i];
		//jsonMusic.index = j;
		var elem = document.createElement('html');
		elem.innerHTML = data;

		// Song title
		var name = $(elem).find('div.live_title').text();
		jsonMusic.name = name;

		var divs = $(elem).find('div.md_list_contents');

		jsonMusic.data = new Array();
		// infos

		if(gtype == 'gf') {
			var isGexist = $(elem).find('div.md_part_GUITAR').length;
			var isBexist = $(elem).find('div.md_part_BASS').length;
			$(divs).each(function(k,v) {
				var jsonGf = new Object();
				var table = $(this).children('table');
				var levels = table.children('thead').children('tr');
				
				// guitar only
				if(isGexist > 0 && isBexist == 0) {
					if($(divs).size() == 3) {
						switch(k) {
						case 0:
							jsonGf.patterncode = 1;
							jsonGf.level = $(levels).children('th.diff_BASIC').children('div.diff_BASIC').children('div.diff_area').get(0).innerHTML;
							break;
						case 1:
							jsonGf.patterncode = 2;
							jsonGf.level = $(levels).children('th.diff_ADVANCED').children('div.diff_ADVANCED').children('div.diff_area').get(0).innerHTML;
							break;
						case 2:
							jsonGf.patterncode = 3;
							jsonGf.level = $(levels).children('th.diff_EXTREME').children('div.diff_EXTREME').children('div.diff_area').get(0).innerHTML;
							break;
						}
					}
					else if($(divs).size() == 4) {
						switch(k) {
						case 0:
							jsonGf.patterncode = 1;
							jsonGf.level = $(levels).children('th.diff_BASIC').children('div.diff_BASIC').children('div.diff_area').get(0).innerHTML;
							break;
						case 1:
							jsonGf.patterncode = 2;
							jsonGf.level = $(levels).children('th.diff_ADVANCED').children('div.diff_ADVANCED').children('div.diff_area').get(0).innerHTML;
							break;
						case 2:
							jsonGf.patterncode = 3;
							jsonGf.level = $(levels).children('th.diff_EXTREME').children('div.diff_EXTREME').children('div.diff_area').get(0).innerHTML;
							break;
						case 3:
							jsonGf.patterncode = 4;
							jsonGf.level = $(levels).children('th.diff_MASTER').children('div.diff_MASTER').children('div.diff_area').get(0).innerHTML;
							break;
						}
					}
				}
				// bass only
				else if(isGexist == 0 && isBexist > 0) {
					if($(divs).size() == 3) {
						switch(k) {
						case 0:
							jsonGf.patterncode = 5;
							jsonGf.level = $(levels).children('th.diff_BASIC').children('div.diff_BASIC').children('div.diff_area').get(0).innerHTML;
							break;
						case 1:
							jsonGf.patterncode = 6;
							jsonGf.level = $(levels).children('th.diff_ADVANCED').children('div.diff_ADVANCED').children('div.diff_area').get(0).innerHTML;
							break;
						case 2:
							jsonGf.patterncode = 7;
							jsonGf.level = $(levels).children('th.diff_EXTREME').children('div.diff_EXTREME').children('div.diff_area').get(0).innerHTML;
							break;
						}
					}
					else if($(divs).size() == 4) {
						switch(k) {
						case 0:
							jsonGf.patterncode = 5;
							jsonGf.level = $(levels).children('th.diff_BASIC').children('div.diff_BASIC').children('div.diff_area').get(0).innerHTML;
							break;
						case 1:
							jsonGf.patterncode = 6;
							jsonGf.level = $(levels).children('th.diff_ADVANCED').children('div.diff_ADVANCED').children('div.diff_area').get(0).innerHTML;
							break;
						case 2:
							jsonGf.patterncode = 7;
							jsonGf.level = $(levels).children('th.diff_EXTREME').children('div.diff_EXTREME').children('div.diff_area').get(0).innerHTML;
							break;
						case 3:
							jsonGf.patterncode = 8;
							jsonGf.level = $(levels).children('th.diff_MASTER').children('div.diff_MASTER').children('div.diff_area').get(0).innerHTML;
							break;
						}
					}
				}
				else {
					if($(divs).size() == 6) {
						switch(k) {
						case 0:
							jsonGf.patterncode = 1;
							jsonGf.level = $(levels).children('th.diff_BASIC').children('div.diff_BASIC').children('div.diff_area').get(0).innerHTML;
							break;
						case 1:
							jsonGf.patterncode = 2;
							jsonGf.level = $(levels).children('th.diff_ADVANCED').children('div.diff_ADVANCED').children('div.diff_area').get(0).innerHTML;
							break;
						case 2:
							jsonGf.patterncode = 3;
							jsonGf.level = $(levels).children('th.diff_EXTREME').children('div.diff_EXTREME').children('div.diff_area').get(0).innerHTML;
							break;
						case 3:
							jsonGf.patterncode = 5;
							jsonGf.level = $(levels).children('th.diff_BASIC').children('div.diff_BASIC').children('div.diff_area').get(0).innerHTML;
							break;
						case 4:
							jsonGf.patterncode = 6;
							jsonGf.level = $(levels).children('th.diff_ADVANCED').children('div.diff_ADVANCED').children('div.diff_area').get(0).innerHTML;
							break;
						case 5:
							jsonGf.patterncode = 7;
							jsonGf.level = $(levels).children('th.diff_EXTREME').children('div.diff_EXTREME').children('div.diff_area').get(0).innerHTML;
							break;
						}
					}
					else if($(divs).size() == 8) {
						switch(k) {
						case 0:
							jsonGf.patterncode = 1;
							jsonGf.level = $(levels).children('th.diff_BASIC').children('div.diff_BASIC').children('div.diff_area').get(0).innerHTML;
							break;
						case 1:
							jsonGf.patterncode = 2;
							jsonGf.level = $(levels).children('th.diff_ADVANCED').children('div.diff_ADVANCED').children('div.diff_area').get(0).innerHTML;
							break;
						case 2:
							jsonGf.patterncode = 3;
							jsonGf.level = $(levels).children('th.diff_EXTREME').children('div.diff_EXTREME').children('div.diff_area').get(0).innerHTML;
							break;
						case 3:
							jsonGf.patterncode = 4;
							jsonGf.level = $(levels).children('th.diff_MASTER').children('div.diff_MASTER').children('div.diff_area').get(0).innerHTML;
							break;
						case 4:
							jsonGf.patterncode = 5;
							jsonGf.level = $(levels).children('th.diff_BASIC').children('div.diff_BASIC').children('div.diff_area').get(0).innerHTML;
							break;
						case 5:
							jsonGf.patterncode = 6;
							jsonGf.level = $(levels).children('th.diff_ADVANCED').children('div.diff_ADVANCED').children('div.diff_area').get(0).innerHTML;
							break;
						case 6:
							jsonGf.patterncode = 7;
							jsonGf.level = $(levels).children('th.diff_EXTREME').children('div.diff_EXTREME').children('div.diff_area').get(0).innerHTML;
							break;
						case 7:
							jsonGf.patterncode = 8;
							jsonGf.level = $(levels).children('th.diff_MASTER').children('div.diff_MASTER').children('div.diff_area').get(0).innerHTML;
							break;
						}
					}
				}
				
				//var body = $(this).children('table').children('tbody').children('tr');
				var body = table.children('tbody').children('tr');
				
				// 성과 데이터
				$(body).each(function(l,vv) {
					switch(l) {
					case 0:
						var playcount = $(this).children('td').get(1).innerHTML.split(' ')[0];
						jsonGf.playcount = playcount;
						break;
					case 1:
						var clearcount = $(this).children('td').get(1).innerHTML.split(' ')[0];
						jsonGf.clearcount = clearcount;
						break;
					case 2:
						var rank;
						$(this).children('td').each(function(zz,zx) {
							if(zz == 2)
								rank = $(this).attr('class').split(' ')[2];
						});
						jsonGf.rank = rank;
						break;
					case 3:
						var rate = $(this).children('td').get(1).innerHTML;
						jsonGf.rate = rate;
						break;
					case 4:
						var score = $(this).children('td').get(1).innerHTML;
						jsonGf.score = score;
						break;
					case 5:
						var combo = $(this).children('td').get(1).innerHTML;
						jsonGf.combo = combo;
						break;
					}
				});
				
				var meter = '';
				var ul = $(this).children('div').children('div').children('ul').children('li');
				$(ul).each(function(l, vv) {
					var str = $(this).attr('class').split(' ')[1];
					meter += str[str.length - 1];
				});
				
				jsonGf.meter = meter;
				
				jsonMusic.data.push(jsonGf);
			});
		}
		else if(gtype == 'dm') {
			$(divs).each(function(k,v) {
				var jsonDm = new Object();
				var table = $(this).children('table');
				var levels = table.children('thead').children('tr');
				
				switch(k) {
				case 0:
					jsonDm.patterncode = 9;
					jsonDm.level = $(levels).children('th.diff_BASIC').children('div.diff_BASIC').children('div.diff_area').get(0).innerHTML;
					break;
				case 1:
					jsonDm.patterncode = 10;
					jsonDm.level = $(levels).children('th.diff_ADVANCED').children('div.diff_ADVANCED').children('div.diff_area').get(0).innerHTML;
					break;
				case 2:
					jsonDm.patterncode = 11;
					jsonDm.level = $(levels).children('th.diff_EXTREME').children('div.diff_EXTREME').children('div.diff_area').get(0).innerHTML;
					break;
				case 3:
					jsonDm.patterncode = 12;
					jsonDm.level = $(levels).children('th.diff_MASTER').children('div.diff_MASTER').children('div.diff_area').get(0).innerHTML;
					break;
				}
				var body = $(this).children('table').children('tbody').children('tr');

				$(body).each(function(l,vv) {
					switch(l) {
					case 0:
						var playcount = $(this).children('td').get(1).innerHTML.split(' ')[0];
						jsonDm.playcount = playcount;
						break;
					case 1:
						var clearcount = $(this).children('td').get(1).innerHTML.split(' ')[0];
						jsonDm.clearcount = clearcount;
						break;
					case 2:
						var rank;
						$(this).children('td').each(function(zz,zx) {
							if(zz == 2)
								rank = $(this).attr('class').split(' ')[2];
						});
						jsonDm.rank = rank;
						break;
					case 3:
						var rate = $(this).children('td').get(1).innerHTML;
						jsonDm.rate = rate;
						break;
					case 4:
						var score = $(this).children('td').get(1).innerHTML;
						jsonDm.score = score;
						break;
					case 5:
						var combo = $(this).children('td').get(1).innerHTML;
						jsonDm.combo = combo;
						break;
					}
				});
				
				var meter = '';
				var ul = $(this).children('div').children('div').children('ul').children('li');
				$(ul).each(function(l, vv) {
					var str = $(this).attr('class').split(' ')[1];
					meter += str[str.length - 1];
				});
				
				jsonDm.meter = meter;
				
				jsonMusic.data.push(jsonDm);
			});
		}
		if(gtype=="dm") {
			jsonRoot.music.dm.push(jsonMusic);
		}
		else if(gtype=="gf") {
			jsonRoot.music.gf.push(jsonMusic);
		}
		console.log("Collected: "+name);
		$("#current").text("Collected: "+name);
	}

	function getIndex(gtype, i, gver) {
		var musicurl = "";
		if(gver == "mx")
			musicurl = "https://p.eagate.573.jp/game/gfdm/gitadora_matixx/p/eam/playdata/music.html";
		else if(gver == "tbre")
			musicurl = "https://p.eagate.573.jp/game/gfdm/gitadora_tbre/p/eam/playdata/music.html";
			
		return $.ajax({
			url: musicurl,
			type: 'GET',
			data: {
				gtype: gtype,
				cat: i
			},
			xhr: function() {
				// Get new xhr object using default factory
				var xhr = jQuery.ajaxSettings.xhr();
				// Copy the browser's native setRequestHeader method
				var setRequestHeader = xhr.setRequestHeader;
				// Replace with a wrapper
				xhr.setRequestHeader = function(name, value) {
					// Ignore the X-Requested-With header
					if (name == 'X-Requested-With') return;
					// Otherwise call the native setRequestHeader method
					// Note: setRequestHeader requires its 'this' to be the xhr object,
					// which is what 'this' is here when executed.
					setRequestHeader.call(this, name, value);
				}
				// pass it on to jQuery
				return xhr;
			},
			async:false
		});
	}
	
	function getTarget(gtype, stype, gver) {
		var targeturl = "";
		if(gver == "mx")
			targeturl = "https://p.eagate.573.jp/game/gfdm/gitadora_matixx/p/eam/playdata/skill.html";
		else if(gver == "tbre")
			targeturl = "https://p.eagate.573.jp/game/gfdm/gitadora_tbre/p/eam/playdata/skill.html";
	
		return $.ajax({
			url: targeturl,
			method: 'GET',
			data: {
				gtype:gtype,
				stype:stype
			},
			xhr: function() {
				// Get new xhr object using default factory
				var xhr = jQuery.ajaxSettings.xhr();
				// Copy the browser's native setRequestHeader method
				var setRequestHeader = xhr.setRequestHeader;
				// Replace with a wrapper
				xhr.setRequestHeader = function(name, value) {
					// Ignore the X-Requested-With header
					if (name == 'X-Requested-With') return;
					// Otherwise call the native setRequestHeader method
					// Note: setRequestHeader requires its 'this' to be the xhr object,
					// which is what 'this' is here when executed.
					setRequestHeader.call(this, name, value);
				}
				// pass it on to jQuery
				return xhr;
			},
			async:false
		});
	}

	function getSongInfo(c, g, i, s, p, gver) {
		var musicurl = "";
		if(gver == "mx")
			musicurl = "https://p.eagate.573.jp/game/gfdm/gitadora_matixx/p/eam/playdata/music_detail.html";
		else if(gver == "tbre")
			musicurl = "https://p.eagate.573.jp/game/gfdm/gitadora_tbre/p/eam/playdata/music_detail.html";
			
		return $.ajax({
			url: musicurl,
			type: 'GET',
			data: {
				gtype: g,
				cat: c,
				index: i,
				sid: s,
				page: p
			},
			xhr: function() {
				// Get new xhr object using default factory
				var xhr = jQuery.ajaxSettings.xhr();
				// Copy the browser's native setRequestHeader method
				var setRequestHeader = xhr.setRequestHeader;
				// Replace with a wrapper
				xhr.setRequestHeader = function(name, value) {
					// Ignore the X-Requested-With header
					if (name == 'X-Requested-With') return;
					// Otherwise call the native setRequestHeader method
					// Note: setRequestHeader requires its 'this' to be the xhr object,
					// which is what 'this' is here when executed.
					setRequestHeader.call(this, name, value);
				}
				// pass it on to jQuery
				return xhr;
			},
			async:false
		});
	}
	
	function getSongInfoForTarget(url) {
		return $.ajax({
			url: url,
			xhr: function() {
				// Get new xhr object using default factory
				var xhr = jQuery.ajaxSettings.xhr();
				// Copy the browser's native setRequestHeader method
				var setRequestHeader = xhr.setRequestHeader;
				// Replace with a wrapper
				xhr.setRequestHeader = function(name, value) {
					// Ignore the X-Requested-With header
					if (name == 'X-Requested-With') return;
					// Otherwise call the native setRequestHeader method
					// Note: setRequestHeader requires its 'this' to be the xhr object,
					// which is what 'this' is here when executed.
					setRequestHeader.call(this, name, value);
				}
				// pass it on to jQuery
				return xhr;
			},
			async:false
		});
	}

	function parseTable(table) {
		var jqt = $(table);

		var array = Array();
		var t = $(jqt).children('tbody').children('tr');
		//console.log(t);
		$(t).each(function(i, v) {
			array[i] = Array();
			$(this).children('td').each(function (j, w) {
				array[i][j] = $(this).text();
			});
		});
		//console.log(array);
		return array;
	}

	function upload(text, type, gver) {
		if (type=='profile') {
		    $.ajax({
		        url: "https://gitadora.info/$/updateProfileOld/"+gver,
		        type: "POST",
		        data: text,
		        contentType: "application/json"
		    }).then(function(data, status, jqxhr) {
		    	if(data==="200") {
		    		alert("[Profile] Update complete");
		    		$("#current").text("[Profile] Update complete");
		    	}
	    		if(data==="500") {
		    		alert("[Profile] Failed to parse data");
		    		$("#current").text("[Profile] Update failed: due to parsing fail");
		    	}
	    		if(data==="501") {
		    		alert("[Profile] Crawl token expired");
		    		$("#current").text("[Profile] Update failed: Token is expired. Please try again from the first step.");
		    	}
		    	
		    	isGFDMall = false;
		    	curnum = 0;
		    });
		}
		else if(type=='skill') {
			$.ajax({
		        url: "https://gitadora.info/$/updateSkillOld/"+gver,
		        type: "POST",
		        data: text,
		        contentType: "application/json"
		    }).then(function(data, status, jqxhr) {
		    	if(data==="200") {
		    		alert("[Skill] Update complete");
		    		$("#current").text("[Skill] Update complete");
		    	}
	    		if(data==="500") {
		    		alert("[Skill] Failed to parse data");
		    		$("#current").text("[Skill] Update failed: due to parsing fail");
		    	}
	    		if(data==="501") {
		    		alert("[Skill] Crawl token expired");
		    		$("#current").text("[Skill] Update failed: Token expired. Please try again from the first step.");
		    	}
		    });
		}
	}

	func.crawlProfile = crawlProfile;
	func.crawlSongs = crawlSongs;
	return func;
}

function crawlRunner(type) {
	var skill = new SkillCrawler();
	
	// MATIXX
	// crawlSongs - 0: all, 1: target, 2: favo, 3: select
	if(type==0) skill.crawlProfile("mx");
	else if(type==1) skill.crawlSongs('gf', 0, delay, null, "mx");
	else if(type==2) skill.crawlSongs('dm', 0, delay, null, "mx");
	else if(type==3) skill.crawlSongs('gf', 1, delay, null, "mx");
	else if(type==4) skill.crawlSongs('dm', 1, delay, null, "mx");
	
	// crawlSongs - 0: all, 1: target, 2: favo, 3: select
	if(type==5) skill.crawlProfile("tbre");
	else if(type==6) skill.crawlSongs('gf', 0, delay, null, "tbre");
	else if(type==7) skill.crawlSongs('dm', 0, delay, null, "tbre");
	else if(type==8) skill.crawlSongs('gf', 1, delay, null, "tbre");
	else if(type==9) skill.crawlSongs('dm', 1, delay, null, "tbre");
	else console.log("[GITADORA Info] Wrong parameter passed");
}

function loadScript(filename, filetype){
    if (filetype=="js"){ //if filename is a external JavaScript file
        var fileref=document.createElement('script')
        fileref.setAttribute("type","text/javascript")
        fileref.setAttribute("src", filename)
    }
    else if (filetype=="css"){ //if filename is an external CSS file
        var fileref=document.createElement("link")
        fileref.setAttribute("rel", "stylesheet")
        fileref.setAttribute("type", "text/css")
        fileref.setAttribute("href", filename)
    }
    if (typeof fileref!="undefined")
        document.getElementsByTagName("head")[0].appendChild(fileref)
}

function setDelay() {
    delay = parseInt($("#delaySlider").val());
    
    if (delay < 10) {
        delay = 10;
    }
    
    $("#delayValue").text(delay);
}

function closeUpdater() {
	location.reload();
}
    
$(function () {
	$("head").append( $("<link rel='stylesheet' type='text/css' />").attr("href", "https://gitadora.info/css/bootstrap.min.css") );
	$("head").append( $("<link rel='stylesheet' type='text/css' />").attr("href", "https://gitadora.info/css/custom/overall-w.css") );
	$("head").append( $("<link rel='stylesheet' type='text/css' />").attr("href", "https://gitadora.info/css/custom/filter.css") );
	$("head").append( $("<link rel='stylesheet' type='text/css' />").attr("href", "https://gitadora.info/css/custom/table.css") );
	
	var inject = 
	"<div style='font-size: 100%; padding: 10px' id='gfdminfo' class='page-header crawler'>"
		+ "<div class='crawler-inner'>"
	    + "<div class='row'>"
	    + "<div class='col-12 crawler-pagetop text-center'>"
	    + "DATA UPDATE (Old Version)  "
    	+ "<a class='btn btn-warning' href='#no_div' onclick='closeUpdater()'>"
    	+ "CLOSE UPDATER</a>"
    	+ "</div>"
	    + "</div>";	
	    inject += "<br/>";
	    
	    if(token == "") {
	    	inject += '<div class="row"><p>'+text.crawler.notlogin[lang]+'</p></div>';
	    }
	    else {
	    	inject += 
				'<div id="desc" style="border: 1px solid black">'
					+ '<div class="row" style="padding:10px">'
					+ '<div class="col-12 text-left" style="padding:10px">'
					+ '<b>LOGIN USER - '+username+'</b><br/><br/>'
					+ text.crawler.loginconfirm[lang]+"</div>"
				+ "</div></div>"
				+ '<div class="row">'
				+ '<div class="col-12" id="current" style="font-size:125%; padding:20px;"></div>'
				+ '</div>'
				+ '<div class="row">'
					+ '<div class="col-12 text-left">'
					+ '<h3>'+text.crawler.pause[lang]+'</h3>'
					+ '</div>'
				+ '</div>'
					+ '<div class="row">'
					+ '<div class="col-12" align="center">'
					+ '<input type="range" id="delaySlider" value="500" min="10" max="2000" oninput="javascript:setDelay();" style="width:90%; font-weight:bold;">'
					+ '<span id="delayValue" style="font-size:22px">500</span> ms</div></div><br/>'
				+ '<div class="row">'
					+ '<div class="col-12 text-left">'
					+ '<h3>'+text.crawler.datat[lang]+'</h3>'
					+ '<h5>'+text.crawler.datas[lang]+'</h5>'
					+ '</div>'
				+ '</div>'
				+ '<div class="row">'
					+ '<div class="col-12 text-left">'
					+ '<h3>MATIXX</h3>'
					+ '</div>'
				+ '</div>'
				+ '<div class="row">'
					+ '<div class="col-sm-6">'
					+ '<a class="btn btn-primary" style="width:100%;" href="#no_div" onclick="crawlRunner(3)">'+text.crawler.gtarget[lang]+'</a>'
					+ '</div>'
					+ '<div class="col-sm-6">'
					+ '<a class="btn btn-primary" style="width:100%;" href="#no_div" onclick="crawlRunner(4)">'+text.crawler.dtarget[lang]+'</a>'
					+ '</div>'
				+ '</div>'
				+ '<div class="row">'
					+ '<div class="col-sm-6">'
					+ '<a class="btn btn-primary" style="width:100%;" href="#no_div" onclick="crawlRunner(1)">'+text.crawler.gall[lang]+'</a>'
					+ '</div>'
					+ '<div class="col-sm-6">'
					+ '<a class="btn btn-primary" style="width:100%;" href="#no_div" onclick="crawlRunner(2)">'+text.crawler.dall[lang]+'</a>'
					+ '</div>'
				+ '</div>'
				+ '<div class="row">'
					+ '<div class="col-12 text-left">'
					+ '<h3>Tri-Boost Re:EVOLVE</h3>'
					+ '</div>'
				+ '</div>'
				+ '<div class="row">'
					+ '<div class="col-sm-6">'
					+ '<a class="btn btn-primary" style="width:100%;" href="#no_div" onclick="crawlRunner(8)">'+text.crawler.gtarget[lang]+'</a>'
					+ '</div>'
					+ '<div class="col-sm-6">'
					+ '<a class="btn btn-primary" style="width:100%;" href="#no_div" onclick="crawlRunner(9)">'+text.crawler.dtarget[lang]+'</a>'
					+ '</div>'
				+ '</div>'
				+ '<div class="row">'
					+ '<div class="col-sm-6">'
					+ '<a class="btn btn-primary" style="width:100%;" href="#no_div" onclick="crawlRunner(6)">'+text.crawler.gall[lang]+'</a>'
					+ '</div>'
					+ '<div class="col-sm-6">'
					+ '<a class="btn btn-primary" style="width:100%;" href="#no_div" onclick="crawlRunner(7)">'+text.crawler.dall[lang]+'</a>'
					+ '</div>'
				+ '</div>';
	    }
	inject += '<br/>&nbsp;<br/>&nbsp;<br/>&nbsp;<br/>&nbsp;<br/><div class="row"><div class="col-xs-12">GITADORA Info developed by <a href="https://twitter.com/prunusnira">@prunusNira</a></div></div>'
		+ '</div></div>';
	$(inject).insertBefore("body");
});
